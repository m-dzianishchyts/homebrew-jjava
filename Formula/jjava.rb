# typed: true
# frozen_string_literal: true

# This file was generated by Brewtap. DO NOT EDIT.
class Jjava < Formula
  desc "Jupyter kernel for executing java code"
  homepage "https://github.com/m-dzianishchyts/jjava"
  url "https://github.com/m-dzianishchyts/jjava/releases/download/1.0a15/jjava-1.0a15-kernelspec.zip"
  sha256 "cf48b185febc133b35967228735e350a0631fb22fc67c3cb1af266460bf6c5e2"
  license "MIT"

  depends_on "expect" => :test

  def install
    libexec.install Dir["*.jar"]
    config = buildpath/"kernel.json"
    inreplace config, "{resource_dir}", libexec
  end

  def caveats
    kernel_path = share/"jupyter"
    jupyter_env = "JUPYTER_PATH"
    <<~EOS
      The installation of the Homebrew package takes place in an isolated environment, so ensure JJava visibility by running:
        grep -q '^export #{jupyter_env}=' ~/.zshrc && sed -i '/^export #{jupyter_env}=/ s|$|:#{kernel_path}|' ~/.zshrc || echo 'export #{jupyter_env}=#{kernel_path}' >> ~/.zshrc; source ~/.zshrc (macOS)
        grep -q '^export #{jupyter_env}=' ~/.bashrc && sed -i '/^export #{jupyter_env}=/ s|$|:#{kernel_path}|' ~/.bashrc || echo 'export #{jupyter_env}=#{kernel_path}' >> ~/.bashrc; source ~/.bashrc (Linux)
      Although JJava doesn't depend on java, it requires jre>=11 to run.
      Make sure you have one in your PATH.
    EOS
  end

  test do
    jupyter = Formula["jupyterlab"].opt_bin/"jupyter"
    assert_match " java ", shell_output("#{jupyter} kernelspec list")

    (testpath/"console.exp").write <<~EOS
      spawn #{jupyter} console --kernel=java
      expect -timeout 30 "In "
      send {System.out.println("Hello world!");\r}
      expect -timeout 10 "In "
      send "\u0004"
      expect -timeout 10 "exit"
      send "y\r"
    EOS
    output = shell_output("expect -f console.exp")
    assert_match "JJava kernel #{version}", output
    assert_match "Hello world!", output
  end
end
